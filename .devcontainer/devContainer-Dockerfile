FROM ubuntu:latest
ENV DEBIAN_FRONTEND=noninteractive
ENV TZ=America/Indiana/Indianapolis
RUN ln -snf /usr/share/zoneinfo/America/$TZ /etc/localtime \
    && echo $TZ > /etc/timezone

RUN apt-get update && apt-get install -y apache2 locales \
    && locale-gen en_US.UTF-8
RUN a2enmod alias && \
    a2enmod headers && \
    a2enmod remoteip && \
    a2enmod rewrite

RUN apt-get install -y \
    php-common \
    composer \
    php-cli \
    php-dom \
    php-json \
    php-readline \
    php-mbstring \
    php-pgsql \
    php-intl \
    php-zip \
    unzip \
    php-curl \
    php-ldap \
    php-xsl \
    libapache2-mod-php \
    make \
    sassc \
    gettext \
    rsync \
    sudo

# Create a normal user account. May need to do some UID matching depending on what the default UID is on a mac.
# There's a setting to auto-adjust the UIDs in the devcontainer.json spec but I haven't tested it.
RUN useradd -ms /bin/bash devuser -G www-data,sudo
RUN echo "devuser ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/devuser

# copy our custom config for the app, as well as an env vars override which lets us run apache as a normal user
COPY apache.conf /etc/apache2/sites-available/000-default.conf
COPY envvars /etc/apache2

#RUN ln -sf /dev/stdout /var/log/apache2/other_vhosts_access.log && chown -R root:www-data /var/log/apache2
RUN chown -R devuser:www-data /var/log/apache2 && chmod 777 /var/log/apache2
#COPY log-to-stdout.conf /etc/apache2/conf-available
#RUN a2enconf log-to-stdout
#RUN a2disconf other-vhosts-access-log
USER devuser
